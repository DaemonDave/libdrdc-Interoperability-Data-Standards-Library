<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.2.5" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
div.olist2 ol {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hlist td {
  padding-bottom: 5px;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){generateToc(2)}
/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, October 2006. License: GPL */

function getText(el) {
  var text = "";
  for (var i = el.firstChild; i != null; i = i.nextSibling) {
    if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
      text += i.data;
    else if (i.firstChild != null)
      text += getText(i);
  }
  return text;
}

function TocEntry(el, text, toclevel) {
  this.element = el;
  this.text = text;
  this.toclevel = toclevel;
}

function tocEntries(el, toclevels) {
  var result = new Array;
  var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
  // Function that scans the DOM tree for header elements (the DOM2
  // nodeIterator API would be a better technique but not supported by all
  // browsers).
  var iterate = function (el) {
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
        var mo = re.exec(i.tagName)
        if (mo)
          result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
        iterate(i);
      }
    }
  }
  iterate(el);
  return result;
}

// This function does the work. toclevels = 1..4.
function generateToc(toclevels) {
  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementsByTagName("body")[0], toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "toc" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
}
/*]]>*/
</script>
<title>DP PTU RTEMS/Linux Driver User Guide</title>
</head>
<body>
<div id="header">
<h1>DP PTU RTEMS/Linux Driver User Guide</h1>
<span id="author">Tie Peng</span><br />
<span id="email"><tt>&lt;<a href="mailto:pengt@sil.sk.ca">pengt@sil.sk.ca</a>&gt;</tt></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="para"><p>The DirectPerception(DP) PanTilt Unit (PTU) RTEMS/Linux Driver was
ported from Miro(Miro-031106) C++ source code.</p></div>
<div class="para"><p>The driver was tested under Cygwin, Fedora Linux 6 and RTEMS 4.7.1.</p></div>
</div>
<h2 id="_architecture">2. Architecture</h2>
<div class="sectionbody">
<div class="para"><p>The driver conatains three levels of routine.</p></div>
<div class="ilist"><ul>
<li>
<p>
User APIs, high-level user interface.
</p>
</li>
<li>
<p>
DP PanTilt Message Handler, DirectPerception PTU serial messages
  processor.
</p>
</li>
<li>
<p>
Low-level serial port driver, contains generic serial port read,
  write and timer driver.
</p>
</li>
</ul></div>
</div>
<h2 id="_driver_usage">3. Driver Usage</h2>
<div class="sectionbody">
<h3 id="_preprocessor_variables">3.1. Preprocessor Variables</h3><div style="clear:left"></div>
<div class="para"><p>The driver defines three variables to control the compilation.</p></div>
<div class="para"><p>In PanTilt.h</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>#define DRDC_DEBUG
#define SIG_INFO_WORKAROUND</tt></pre>
</div></div>
<div class="para"><p>In test.c</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>#define RTEMS_DRIVER</tt></pre>
</div></div>
<div class="para"><p>Usage:</p></div>
<div class="ilist"><ul>
<li>
<p>
To print out verbose debug information, define the
  DRDC_DEBUG. Otherwise, comment out the line.
</p>
</li>
<li>
<p>
To work around a signal pointer passing bug in RTEMS 4.71, define
  the SIG_INFO_WORKAROUND. Otherwise, comment out the line.
</p>
</li>
<li>
<p>
To compile the test program under RTEMS, define the
  RTEMS_DRIVER. Otherwise, comment out the line.
</p>
</li>
</ul></div>
<h3 id="_compile_and_run">3.2. Compile and Run</h3><div style="clear:left"></div>
<div class="ilist"><ul>
<li>
<p>
Compile and run the example under Cygwin
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><tt>./configure
make
./src/test.exe</tt></pre>
</div></div>
<div class="ilist"><ul>
<li>
<p>
Compile and run the example under Fedora Linux. Edit the file ./src/Makefile.am.
</p>
</li>
</ul></div>
<div class="para"><p>Replace:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>LDADD = -lm</tt></pre>
</div></div>
<div class="para"><p>With:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>LDADD =  -lrt -lm</tt></pre>
</div></div>
<div class="para"><p>Then, use the same commands to compile and run.</p></div>
<div class="ilist"><ul>
<li>
<p>
Compile and run the example under i386 RTEMS
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><tt>export RTEMS_MAKEFILE_PATH=/usr/local/rtems/rtems4.7.1/i386-rtems4.7.1/pc686
make -f src/Makefile_rtems</tt></pre>
</div></div>
<div class="para"><p>Then, copy the executable file ./src/o-optimize/test.exe to a RTEMS
bootable floppy disk and boot from this disk.</p></div>
<h3 id="_test_on_rtems_i386">3.3. Test on RTEMS i386</h3><div style="clear:left"></div>
<div class="ilist"><ul>
<li>
<p>
Make bootable floppy disk
</p>
</li>
</ul></div>
<div class="para"><p>All the files need to make a bootable floppy disk in the Windows
environment were put in the rtems_boot directory.</p></div>
<div class="para"><p>Run rawwritewin.exe in Windows to write the image (floppy.img) to a floppy disk.</p></div>
<div class="ilist"><ul>
<li>
<p>
Compress the executable file
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><tt>cat ./src/o-optimize/test.exe | gzip -9 &gt; kernel.gz</tt></pre>
</div></div>
<div class="ilist"><ul>
<li>
<p>
Copy the file to the floppy disk
</p>
</li>
<li>
<p>
Boot from the floppy disk and run
</p>
</li>
</ul></div>
</div>
<h2 id="_user_apis">4. User APIs</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre><tt>PanTiltID_t *  createPanTilt (char *serialName, double readTimeout, double writeTimeout, int signalNumber)
  Create PanTilt handler.

int  destroyPanTilt (PanTiltID_t *panTiltID)
  Destroy PanTilt Handler.

int  getPan (PanTiltID_t *panTiltID, double *panValue)
  Return pan position.

int  getTilt (PanTiltID_t *panTiltID, double *tiltValue)
  Return tilt position.

int  setPan (PanTiltID_t *panTiltID, double panValue)
  Set pan position.

int  setTilt (PanTiltID_t *panTiltID, double tiltValue)
  Set tilt position.

int  setPosition (PanTiltID_t *panTiltID, const PanTiltPositionIDL_t *dest)
  Set pan and tilt position.

int  getPosition (PanTiltID_t *panTiltID, PanTiltPositionIDL_t *result)
  Return pan and tilt position.

int  setWaitPosition (PanTiltID_t *panTiltID, const PanTiltPositionIDL_t *dest)
  Await pan and tilt postion command completion.

int  getSpdAcc (PanTiltID_t *panTiltID, PanTiltSpdAccIDL_t *result)
  Return speed and acceleration settings.

int  setSpdAcc (PanTiltID_t *panTiltID, const PanTiltSpdAccIDL_t *dest)
  Set speed and acceleration.

int  getLimits (PanTiltID_t *panTiltID, PanTiltLimitsIDL_t *result)
  Query limit position.

int  setPowers (PanTiltID_t *panTiltID, PanTiltPowersIDL_t *dest)
  Set stationary power and in-motion power settings.

int  getPowers (PanTiltID_t *panTiltID, PanTiltPowersIDL_t *result)
  Return stationary power and in-motion power settings.</tt></pre>
</div></div>
</div>
<h2 id="_known_problems">5. Known Problems</h2>
<div class="sectionbody">
<div class="vlist"><dl>
<dt>
No data race prevention mechanism is provided in the driver
</dt>
<dd>
<p>
The driver was designed to be simple. It leaves the user to add his
own data race prevention scheme such as mutex and condition variable. The
simplest way is to define a PanTilt token and to use condition variable
on the token.
</p>
</dd>
<dt>
Signal pointer passing bug in RTEMS 4.7.1
</dt>
<dd>
<p>
The mechanism that passes a pointer to the signal handler doesn't work
in RTEMS 4.7.1. To work around it, a global variable called
globalTimeoutFlag was defined to timeout a serial port. If the
workaround is not used, the driver will hang when the PTU is not
powered on. The Linux platform doesn't have this problem.
</p>
</dd>
</dl></div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2008-04-09 11:20:41 CST
</div>
</div>
</body>
</html>
